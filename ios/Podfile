# 这里的路径加上 rescue nil 增加容错性
load File.expand_path(File.join('Flutter', 'podhelper.rb'), __dir__) rescue nil

platform :ios, '12.0'

target 'Runner' do
  # 阿里 SDK 必须使用静态链接模式
  use_frameworks! :linkage => :static

  use_modular_headers!

  # 只有在 podhelper 加载成功时才调用
  if respond_to?(:flutter_install_all_ios_pods)
    flutter_install_all_ios_pods File.dirname(File.realpath(__FILE__))
  end
end

post_install do |installer|
  # 1. 扩大搜索范围：直接定位 Pods 目录下所有可能存放头文件的路径
  # 这样不仅能找到插件的头文件，还能找到阿里 SDK 核心库的头文件
  extra_search_paths = [
    '"$(SRCROOT)/Pods/Headers/Public"',
    '"$(SRCROOT)/Pods/Headers/Public/flutter_livepush_plugin"',
    '"$(SRCROOT)/Pods/Headers/Public/AliVCSDK_InteractiveLive"',
    '"$(SRCROOT)/Pods/AliVCSDK_InteractiveLive/**"', # 递归查找阿里 SDK 内部
    '"$(SRCROOT)/Pods/flutter_livepush_plugin/**"'  # 递归查找插件内部
  ]

  installer.pods_project.targets.each do |target|
    flutter_additional_ios_build_settings(target) rescue nil

    target.build_configurations.each do |config|
      config.build_settings['IPHONEOS_DEPLOYMENT_TARGET'] = '13.0'
      config.build_settings['EXCLUDED_ARCHS[sdk=iphonesimulator*]'] = 'arm64'

      # 开启非模块化引用，这是解决“阿里 SDK 这种老旧静态库”报错的命门
      config.build_settings['CLANG_ALLOW_NON_MODULAR_INCLUDES_IN_FRAMEWORK_MODULES'] = 'YES'

      # 针对主项目 Runner 注入全量搜索路径
      if target.name == 'Runner'
        config.build_settings['HEADER_SEARCH_PATHS'] ||= '$(inherited) '
        extra_search_paths.each do |path|
          config.build_settings['HEADER_SEARCH_PATHS'] << "#{path} "
        end
      end
    end
  end

  # --- 2. 实时强改补丁（保持不变，增加一行日志确认） ---
  registrant_path = File.join(File.dirname(__FILE__), 'Runner', 'GeneratedPluginRegistrant.m')
  if File.exist?(registrant_path)
    puts "------------------------------------------------"
    puts "ACTION: Patching GeneratedPluginRegistrant.m"
    contents = File.read(registrant_path)
    contents.gsub!(/@import\s+flutter_livepush_plugin;/, '#import "AlivcLivePusherPlugin.h"')
    contents.gsub!(/#import\s+<flutter_livepush_plugin\/AlivcLivePusherPlugin\.h>/, '#import "AlivcLivePusherPlugin.h"')
    File.open(registrant_path, 'w') { |file| file.puts contents }
    puts "------------------------------------------------"
  end
end
