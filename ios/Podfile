# 1. 彻底移除对外部文件的 load 依赖，手动定义必需的方法
def flutter_install_all_ios_pods(ios_application_path = nil)
  # 空实现，防止调用报错
end

def flutter_additional_ios_build_settings(target)
  # 空实现，防止调用报错
end

platform :ios, '13.0'

target 'Runner' do
  # 必须使用静态链接以兼容阿里 SDK
  use_frameworks! :linkage => :static
  use_modular_headers!

  # 这里如果报错，可以暂时注释掉。在 CI 环境中，Codemagic 通常会自动处理插件
  # flutter_install_all_ios_pods File.dirname(File.realpath(__FILE__))
end

post_install do |installer|
  # 增强路径搜索：火力覆盖
  extra_search_paths = [
    '"$(SRCROOT)/Pods/Headers/Public"',
    '"$(SRCROOT)/Pods/Headers/Public/flutter_livepush_plugin"',
    '"$(SRCROOT)/Pods/Headers/Public/AliVCSDK_InteractiveLive"',
    '"$(SRCROOT)/Pods/AliVCSDK_InteractiveLive/**"',
    '"$(SRCROOT)/Pods/flutter_livepush_plugin/**"'
  ]

  installer.pods_project.targets.each do |target|
    target.build_configurations.each do |config|
      config.build_settings['IPHONEOS_DEPLOYMENT_TARGET'] = '13.0'
      config.build_settings['EXCLUDED_ARCHS[sdk=iphonesimulator*]'] = 'arm64'
      config.build_settings['CLANG_ALLOW_NON_MODULAR_INCLUDES_IN_FRAMEWORK_MODULES'] = 'YES'

      if target.name == 'Runner'
        config.build_settings['HEADER_SEARCH_PATHS'] ||= '$(inherited) '
        extra_search_paths.each { |path| config.build_settings['HEADER_SEARCH_PATHS'] << "#{path} " }
      end
    end
  end

  # 实时修正 GeneratedPluginRegistrant.m
  registrant_path = File.join(File.dirname(__FILE__), 'Runner', 'GeneratedPluginRegistrant.m')
  if File.exist?(registrant_path)
    contents = File.read(registrant_path)
    contents.gsub!(/@import\s+flutter_livepush_plugin;/, '#import "AlivcLivePusherPlugin.h"')
    File.open(registrant_path, 'w') { |file| file.puts contents }
  end
end