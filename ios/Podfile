# 1. 彻底移除对外部文件的 load 依赖，手动定义必需的方法
def flutter_install_all_ios_pods(ios_application_path = nil)
  # 空实现，防止调用报错
end

def flutter_additional_ios_build_settings(target)
  # 空实现，防止调用报错
end

platform :ios, '13.0'

target 'Runner' do
  # 必须使用静态链接以兼容阿里 SDK
  use_frameworks! :linkage => :static
  use_modular_headers!

  # 这里如果报错，可以暂时注释掉。在 CI 环境中，Codemagic 通常会自动处理插件
  # flutter_install_all_ios_pods File.dirname(File.realpath(__FILE__))
end

post_install do |installer|
  installer.pods_project.targets.each do |target|
    target.build_configurations.each do |config|
      config.build_settings['IPHONEOS_DEPLOYMENT_TARGET'] = '13.0'
      config.build_settings['EXCLUDED_ARCHS[sdk=iphonesimulator*]'] = 'arm64'
      config.build_settings['CLANG_ALLOW_NON_MODULAR_INCLUDES_IN_FRAMEWORK_MODULES'] = 'YES'

      if target.name == 'Runner'
        # 1. 注入桥接头文件路径
        config.build_settings['SWIFT_OBJC_BRIDGING_HEADER'] = 'Runner/Runner-Bridging-Header.h'

        # 2. 增强头文件搜索路径
        config.build_settings['HEADER_SEARCH_PATHS'] ||= '$(inherited) '
        config.build_settings['HEADER_SEARCH_PATHS'] << '"$(SRCROOT)/Pods/Headers/Public/**" '
        config.build_settings['HEADER_SEARCH_PATHS'] << '"$(SRCROOT)/Pods/flutter_livepush_plugin/**" '
      end
    end
  end

  # 3. 实时补丁：继续强改 GeneratedPluginRegistrant.m
  registrant_path = File.join(File.dirname(__FILE__), 'Runner', 'GeneratedPluginRegistrant.m')
  if File.exist?(registrant_path)
    contents = File.read(registrant_path)
    # 将报错的 @import 替换为 #import
    contents.gsub!(/@import\s+flutter_livepush_plugin;/, '#import "AlivcLivePusherPlugin.h"')
    File.open(registrant_path, 'w') { |file| file.puts contents }
  end
end